<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>WARest Login</title>
    <link rel="icon" href="/media/favicon.png" />
    <style>
      :root {
        color-scheme: dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        --bg: #020617;
        --card: rgba(10, 17, 35, 0.96);
        --border: rgba(148, 163, 184, 0.28);
        --border-subtle: rgba(148, 163, 184, 0.16);
        --accent: #60a5fa;
        --accent-strong: #3b82f6;
        --danger: #f97373;
        --danger-soft: rgba(248, 113, 113, 0.1);
        --text: #f9fafb;
        --muted: #94a3b8;
        --radius-lg: 20px;
        --radius-md: 12px;
        --ring: 0 0 0 1px rgba(148, 163, 184, 0.5),
          0 0 0 4px rgba(96, 165, 250, 0.35);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        color: var(--text);
        background: radial-gradient(
            circle at 0 0,
            rgba(56, 189, 248, 0.22),
            transparent 55%
          ),
          radial-gradient(
            circle at 100% 0,
            rgba(129, 140, 248, 0.22),
            transparent 55%
          ),
          radial-gradient(
            circle at 50% 100%,
            rgba(52, 211, 153, 0.18),
            transparent 55%
          ),
          linear-gradient(160deg, #020617 0%, #020617 45%, #020617 100%);
      }

      main {
        width: 100%;
        max-width: 420px;
      }

      .login-card {
        background: var(--card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-subtle);
        padding: 32px 28px 26px;
        box-shadow: 0 26px 80px rgba(15, 23, 42, 0.75),
          0 0 0 1px rgba(15, 23, 42, 0.9);
        -webkit-backdrop-filter: blur(16px);
        backdrop-filter: blur(16px);
      }

      .login-logo {
        display: block;
        margin: 4px auto 18px;
        width: 64px;
        height: 64px;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: radial-gradient(circle at 30% 0, #035774, #00335dbb);
        object-fit: cover;
      }

      .login-header {
        text-align: center;
        margin-bottom: 45px;
      }

      #loginUsername {
        height: 44px !important;
        padding: 0 12px !important;
        border-radius: 12px;
        border: 1px solid var(--border-subtle) !important;
        background: rgba(15, 23, 42, 0.9) !important;
        color: var(--text) !important;
        font-size: 0.96rem !important;
        display: block;
      }
      h1 {
        font-size: 1.6rem;
        margin: 0;
        letter-spacing: -0.03em;
      }

      p.subtitle {
        margin: 8px 0 24px;
        color: var(--muted);
        font-size: 0.95rem;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      label {
        display: block;
        margin-bottom: 6px;
        color: var(--muted);
        font-size: 0.84rem;
        font-weight: 500;
      }

      .field-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .input-with-icon {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-with-icon input {
        padding-right: 46px;
      }

      .input-with-icon button {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: transparent;
        color: var(--muted);
        width: 32px;
        height: 32px;
        border-radius: 999px;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: background 0.15s ease, color 0.15s ease,
          transform 0.15s ease;
      }

      .input-with-icon button:hover {
        background: rgba(15, 23, 42, 0.9);
        color: var(--text);
        transform: translateY(-50%) scale(1.02);
      }

      .icon-eye {
        width: 18px;
        height: 18px;
      }

      .icon-eye.hidden {
        display: none;
      }
      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 11px 12px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text);
        font-size: 0.96rem;
        transition: border-color 0.15s ease, box-shadow 0.15s ease,
          background 0.15s ease, transform 0.05s ease;
      }

      input::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      input:focus-visible {
        outline: none;
        border-color: var(--accent);
        box-shadow: var(--ring);
        background: rgba(15, 23, 42, 1);
      }

      input.input-error {
        border-color: var(--danger);
        background: var(--danger-soft);
      }

      button[type="submit"] {
        margin-top: 4px;
        border: none;
        border-radius: 999px;
        padding: 11px 14px;
        font-weight: 600;
        font-size: 0.98rem;
        cursor: pointer;
        background: linear-gradient(
          120deg,
          var(--accent),
          var(--accent-strong)
        );
        color: #020617;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: transform 0.18s ease, box-shadow 0.18s ease,
          filter 0.18s ease, opacity 0.15s ease;
      }

      button[type="submit"]:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 32px rgba(37, 99, 235, 0.45);
        filter: brightness(1.05);
      }

      button[type="submit"]:not(:disabled):active {
        transform: translateY(0);
        box-shadow: 0 4px 14px rgba(37, 99, 235, 0.35);
      }

      button[type="submit"]:disabled {
        opacity: 0.7;
        cursor: wait;
        box-shadow: none;
      }

      .login-msg {
        min-height: 18px;
        font-size: 0.86rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .login-msg.show {
        color: var(--danger);
      }

      .login-info {
        margin-top: 20px;
        font-size: 0.85rem;
        color: var(--muted);
        text-align: center;
      }

      .login-info a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 500;
      }

      .login-info a:hover {
        text-decoration: underline;
      }

      .screen-reader-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }

      @media (max-width: 520px) {
        body {
          padding: 16px;
        }
        .login-card {
          padding: 24px 20px 22px;
          border-radius: 18px;
        }
        h1 {
          font-size: 1.4rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <section class="login-card" aria-labelledby="login-title">
        <img
          src="/media/warest-logo.png"
          alt="WARest Logo"
          class="login-logo"
          width="64"
          height="64"
        />
        <div class="login-header">
          <h1 id="login-title">Sign in to WARest</h1>
        </div>

        <form id="loginForm" novalidate>
          <div class="field-group">
            <label for="loginUsername">Username</label>
            <input
              id="loginUsername"
              name="username"
              type="text"
              autocomplete="username"
              placeholder="Enter your username"
              required
            />
          </div>

          <div class="field-group">
            <label for="loginPassword">Password</label>
            <div class="input-with-icon">
              <input
                id="loginPassword"
                name="password"
                type="password"
                autocomplete="current-password"
                placeholder="Enter your password"
                required
              />
              <button
                id="togglePassword"
                type="button"
                aria-label="Show password"
                title="Show password"
              >
                <svg
                  class="icon-eye icon-eye-open"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <path
                    d="M2.458 12C3.732 7.943 7.522 5 13 5s9.268 2.943 10.542 7c-1.274 4.057-5.064 7-10.542 7S3.732 16.057 2.458 12z"
                  />
                  <circle cx="13" cy="12" r="3.2" />
                </svg>
                <svg
                  class="icon-eye icon-eye-closed hidden"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <path
                    d="M3 3l18 18M9.9 9.9a3 3 0 0 0 4.2 4.2M6.71 6.71C4.58 8.07 2.91 10.03 1.77 12c1.83 3.19 5.09 6 10.23 6 1.54 0 2.97-.27 4.26-.74M17.29 17.29C19.42 15.93 21.09 13.97 22.23 12c-1.83-3.19-5.09-6-10.23-6-1.11 0-2.18.15-3.19.42"
                  />
                </svg>
              </button>
            </div>
          </div>

          <!-- Honeypot anti-bot -->
          <input
            id="loginWebsite"
            type="text"
            class="screen-reader-only"
            tabindex="-1"
            aria-hidden="true"
            autocomplete="off"
          />

          <div
            class="login-msg"
            id="loginError"
            aria-live="polite"
            role="status"
          ></div>

          <button type="submit" id="loginSubmit">Sign in</button>
        </form>
      </section>
    </main>

    <script src="/auth.js"></script>
    <script>
      (() => {
        const params = new URLSearchParams(window.location.search || "");
        const nextRaw = params.get("next") || "/";
        const reason = params.get("reason") || "";
        const errBox = document.getElementById("loginError");

        const form = document.getElementById("loginForm");
        const btn = document.getElementById("loginSubmit");
        const usernameInput = document.getElementById("loginUsername");
        const passwordInput = document.getElementById("loginPassword");
        const honeypot = document.getElementById("loginWebsite");
        const togglePassword = document.getElementById("togglePassword");
        const AUTH = window.WAREST_AUTH || null;

        const setFieldErrorState = (hasError) => {
          if (!usernameInput || !passwordInput) return;
          [usernameInput, passwordInput].forEach((el) => {
            if (hasError) {
              el.classList.add("input-error");
              el.setAttribute("aria-invalid", "true");
            } else {
              el.classList.remove("input-error");
              el.removeAttribute("aria-invalid");
            }
          });
        };

        const showAutoRedirect = (msg) => {
          if (subtitle) {
            subtitle.textContent =
              msg || "Detecting existing WARest session...";
          }
          if (btn) {
            btn.disabled = true;
            btn.textContent = "Checking session...";
          }
        };

        const attemptAutoLogin = async () => {
          try {
            if (!AUTH?.getSession) return false;
            const session = AUTH.getSession() || {};
            if (!session.apiKey) return false;
            showAutoRedirect(
              `Signed in as ${session.username || "user"} — redirecting...`
            );
            await Promise.resolve(
              AUTH.ensureDocsSession?.(session.apiKey)
            ).catch(() => {});
            redirectAfterLogin();
            return true;
          } catch {
            return false;
          }
        };

        if (AUTH) {
          attemptAutoLogin();
          AUTH.subscribe?.((event) => {
            if (event === "login") attemptAutoLogin();
          });
        }

        if (togglePassword && passwordInput) {
          let reveal = false;
          togglePassword.addEventListener("click", () => {
            reveal = !reveal;
            passwordInput.type = reveal ? "text" : "password";
            togglePassword.setAttribute(
              "aria-label",
              reveal ? "Hide password" : "Show password"
            );
            togglePassword.setAttribute(
              "title",
              reveal ? "Hide password" : "Show password"
            );
            const iconOpen = togglePassword.querySelector(".icon-eye-open");
            const iconClosed = togglePassword.querySelector(".icon-eye-closed");
            if (iconOpen && iconClosed) {
              iconOpen.classList.toggle("hidden", reveal);
              iconClosed.classList.toggle("hidden", !reveal);
            }
          });
        }

        try {
          const savedUser = localStorage.getItem("wa.username");
          if (savedUser && usernameInput) usernameInput.value = savedUser;
        } catch {}

        const buildTarget = () => {
          try {
            const nextUrl = new URL(nextRaw, window.location.origin);
            if (nextUrl.origin !== window.location.origin) return "/";
            return nextUrl.pathname + nextUrl.search + nextUrl.hash;
          } catch {
            return "/";
          }
        };

        const redirectAfterLogin = () => {
          window.location.replace(buildTarget());
        };

        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (honeypot.value.trim()) return;

          const username = usernameInput.value.trim();
          const password = passwordInput.value;
          setFieldErrorState(false);

          if (!username || !password) {
            errBox.textContent = "Username and password are required.";
            errBox.classList.add("show");
            setFieldErrorState(true);
            return;
          }

          const defaultText = btn.textContent;
          btn.disabled = true;
          btn.textContent = "Signing in...";
          errBox.textContent = "";
          errBox.classList.remove("show");

          try {
            const resp = await fetch("/api/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
              credentials: "same-origin",
            });

            const data = await resp.json().catch(() => ({}));

            if (!resp.ok) {
              const retryAfter = data?.retryAfter;
              let message =
                data?.error || `Login failed (status ${resp.status})`;
              if (retryAfter) {
                message += ` — retry after ${retryAfter}s`;
              }
              throw new Error(message);
            }

            try {
              const auth = window.WAREST_AUTH;
              if (auth && typeof auth.setSession === "function") {
                auth.setSession(
                  {
                    apiKey: data.apiKey || "",
                    username: data.username || username,
                    baseUrl: window.location.origin,
                    isAdmin: !!data.isAdmin,
                  },
                  { broadcast: true, source: "login" }
                );
                auth.ensureDocsSession?.(data.apiKey || "");
              } else {
                localStorage.setItem("wa.apiKey", data.apiKey || "");
                localStorage.setItem("wa.username", data.username || username);
                localStorage.setItem("wa.baseUrl", window.location.origin);
                localStorage.setItem("wa.isAdmin", data.isAdmin ? "1" : "");
              }
            } catch {}

            redirectAfterLogin();
          } catch (err) {
            errBox.textContent = err?.message || "Login failed.";
            errBox.classList.add("show");
            setFieldErrorState(true);
          } finally {
            btn.disabled = false;
            btn.textContent = defaultText;
            if (passwordInput) passwordInput.value = "";
          }
        });
      })();
    </script>
  </body>
</html>
